<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>

  <!-- Tailwind (apenas utilit√°rio de estilo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --card:#111827; --bg:#0b1220; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { background: var(--bg); color: #fff; margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    .grid-container { display: grid; gap: 1rem; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1024px) { .grid-container { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .grid-container { grid-template-columns: 1fr; } }

    .video-card {
      background: var(--card);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      transition: box-shadow .2s ease, transform .08s ease;
      position: relative;
    }
    .video-card.dragging { opacity: .75; transform: scale(.995); }
    .video-card .bar {
      display:flex; align-items:center; justify-content:space-between;
      padding: .65rem .9rem; border-top: 1px solid rgba(255,255,255,.06);
    }
    .chip { font-size: .72rem; opacity: .85; }
    .kbd { background: rgba(255,255,255,.1); padding: .1rem .35rem; border-radius: 4px; font-size: .72rem; }
    .btn {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.45rem .7rem; border-radius:.6rem;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
      cursor:pointer; user-select:none;
    }
    .btn:hover { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.25); }
    .btn:active { transform: translateY(1px); }
    .btn-danger { background:rgba(255,77,77,.15); border-color:rgba(255,77,77,.35); }
    .btn-danger:hover { background:rgba(255,77,77,.25); }
    .pill {
      border:1px dashed rgba(255,255,255,.18); border-radius:.6rem; padding:.3rem .55rem; font-size:.76rem; opacity:.9;
    }
    .badge {
      padding:.15rem .45rem; border-radius:.45rem; font-size:.7rem;
      background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
    }
    .menu {
      position:absolute; right:.6rem; top:.6rem; z-index:3;
      display:flex; align-items:center; gap:.4rem;
    }
    .menu .select, .menu select {
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.2);
      padding:.35rem .45rem; border-radius:.5rem; font-size:.8rem; color:#fff;
    }
    .menu .handle { cursor:grab; }
    .offline-banner {
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: 14px; background:#1f2937; border:1px solid rgba(255,255,255,.12);
      padding:.5rem .8rem; border-radius:.7rem; z-index:20; box-shadow:0 6px 20px rgba(0,0,0,.4);
      display:none;
    }
    .ghost {
      border:2px dashed rgba(255,255,255,.25);
      background: rgba(255,255,255,.04);
      height: 260px; border-radius: 12px;
    }
    .hidden { display:none !important; }
    iframe { width:100%; aspect-ratio: 16 / 9; border:0; background:#000; display:block; }
    .header {
      display:flex; align-items:center; justify-content:space-between;
      gap:1rem; margin: .6rem 0 1rem 0;
    }
    .header h1 { font-size: clamp(1.15rem, 1.6vw, 1.45rem); margin:0; opacity:.95; letter-spacing:.2px; }
    .header .tools { display:flex; align-items:center; gap:.4rem; }
    .link { text-decoration: underline; text-underline-offset: 3px; opacity:.9; }
  </style>

  <!-- ====== PORTINHA (login antes de carregar qualquer coisa) ====== -->
  <script>
    (function gate() {
      const USER = "OPERACAOCPM";
      const PASS = "CAVPMDRONES";
      try {
        let ok = false;
        while (!ok) {
          const u = prompt("Usu√°rio:");
          if (u === null) { document.write("<h2 style='color:#fff;text-align:center;margin-top:35vh'>Acesso cancelado.</h2>"); throw new Error("Login cancelado"); }
          const p = prompt("Senha:");
          if (p === null) { document.write("<h2 style='color:#fff;text-align:center;margin-top:35vh'>Acesso cancelado.</h2>"); throw new Error("Login cancelado"); }
          if (u === USER && p === PASS) { ok = true; break; }
          alert("Credenciais incorretas. Tente novamente.");
        }
      } catch(e) { console.error(e); }
    })();
  </script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Dashboard Programa de Policiamento com Drones <span class="badge" id="modeBadge">carregando‚Ä¶</span></h1>
      <div class="tools">
        <span class="pill">Cols: <span id="colsInfo">2</span></span>
        <span class="pill">Qualidade padr√£o: <span id="qDefaultInfo">144p</span></span>
        <a id="toggleLink" class="btn" href="#">Trocar modo</a>
      </div>
    </div>

    <div id="grid" class="grid-container"></div>
    <div id="emptyState" class="hidden" style="margin-top:2rem; text-align:center; opacity:.9">
      <p>Nenhum v√≠deo configurado.</p>
      <p class="text-sm opacity-80">No modo editor, clique em <span class="kbd">+</span> para adicionar IDs de v√≠deos ou playlists do YouTube.</p>
    </div>
  </div>

  <div id="offlineBanner" class="offline-banner">Modo offline: exibindo √∫ltimo layout salvo.</div>

  <!-- ====== Template: Card ====== -->
  <template id="cardTpl">
    <div class="video-card" draggable="false">
      <div class="menu">
        <select class="select q-select" title="Qualidade">
          <option value="tiny">144p</option>
          <option value="small">240p</option>
          <option value="medium">360p</option>
          <option value="large">480p</option>
          <option value="hd720">720p</option>
          <option value="hd1080">1080p</option>
          <option value="highres">M√°x</option>
        </select>
        <button class="btn btn-danger btn-remove hidden" title="Remover">Remover</button>
        <button class="btn handle hidden" title="Arrastar">‚áÖ</button>
      </div>
      <iframe loading="lazy" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      <div class="bar">
        <div class="title text-sm font-semibold"></div>
        <div class="chip opacity-80"></div>
      </div>
    </div>
  </template>

  <!-- ====== Painel r√°pido do Editor ====== -->
  <div id="editorBar" class="hidden" style="position:fixed; right:16px; bottom:16px; display:flex; gap:.4rem; z-index:5;">
    <button id="addBtn" class="btn" title="Adicionar v√≠deo/playlist">+</button>
    <button id="saveBtn" class="btn" title="Salvar layout">Salvar</button>
    <button id="clearBtn" class="btn btn-danger" title="Limpar tudo">Limpar</button>
  </div>

  <!-- ======================= SCRIPTS ======================= -->

  <!-- YouTube Iframe API -->
  <script>
    // Carrega a API uma √∫nica vez
    (function loadYT(){
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();
  </script>

  <!-- Firebase (v8 p/ simplicidade) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ========= CONFIG =========
    const DEFAULT_QUALITY = "tiny"; // 144p
    const QUALITY_LABEL   = { tiny:"144p", small:"240p", medium:"360p", large:"480p", hd720:"720p", hd1080:"1080p", highres:"M√°x" };
    const DB_PATH         = "dashboards/main";   // ajuste se usar outro n√≥
    const Q_ORDER         = ["tiny","small","medium","large","hd720","hd1080","highres"];
    let   YT_READY        = false;

    // üîß Substitua abaixo pela sua config real, se desejar usar Firebase
    const FIREBASE = {
      apiKey: "AIzaSy_EXEMPLO_SUBSTITUA",
      authDomain: "SEU-APP.firebaseapp.com",
      databaseURL: "https://SEU-APP-default-rtdb.firebaseio.com",
      projectId: "SEU-APP",
      storageBucket: "SEU-APP.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:abcdefghijkl",
      measurementId: "G-XXXXXXX"
    };

    // Safe init do Firebase (opcional)
    let db = null;
    try {
      firebase.initializeApp(FIREBASE);
      db = firebase.database();
      console.log("[Firebase] Inicializado");
    } catch (e) {
      console.warn("[Firebase] N√£o inicializado (ok se estiver usando apenas localStorage).", e?.message || e);
    }

    // ========= HELPERS =========
    const qs  = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const esc = s => (s||"").toString().replace(/[&<>"'`=\/]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[m]));
    const param = (k, d=null) => new URLSearchParams(location.search).get(k) ?? d;
    const MODE = (param("mode","view")+"").toLowerCase() === "edit" ? "edit" : "view";
    const VIEW_COLS_OVERRIDE = param("cols", null);
    const colsInfo = qs("#colsInfo");
    const qDefaultInfo = qs("#qDefaultInfo");
    const modeBadge = qs("#modeBadge");
    const toggleLink = qs("#toggleLink");

    let PLAYERS = {};   // id -> YT.Player
    let CARDS   = [];   // estrutura do layout (array de objetos)

    function uid() { return Math.random().toString(36).slice(2,9); }

    function setModeUI(){
      modeBadge.textContent = (MODE === "edit" ? "EDITOR" : "VISUALIZADOR");
      modeBadge.className = "badge " + (MODE==="edit" ? "" : "");
      const tpl = new URL(location.href);
      tpl.searchParams.set("mode", MODE === "edit" ? "view" : "edit");
      toggleLink.href = tpl.toString();
      qs("#editorBar").classList.toggle("hidden", MODE!=="edit");
    }

    function applyGridCols(){
      const grid = qs("#grid");
      const cols = VIEW_COLS_OVERRIDE ? parseInt(VIEW_COLS_OVERRIDE, 10) : (CARDS.cols || 2);
      const safe = Math.min(4, Math.max(1, (isFinite(cols) ? cols : 2)));
      grid.style.gridTemplateColumns = `repeat(${safe}, minmax(0, 1fr))`;
      colsInfo.textContent = safe;
      CARDS.cols = safe;
    }

    function showOfflineBanner(show){
      qs("#offlineBanner").style.display = show ? "block" : "none";
    }

    // ========= STORAGE (Local + Firebase) =========
    const LS_KEY = "drone_dash_state_v12";

    function saveLocal(){
      const data = JSON.stringify(CARDS);
      try { localStorage.setItem(LS_KEY, data); } catch(e){}
    }

    function loadLocal(){
      try {
        const data = localStorage.getItem(LS_KEY);
        return data ? JSON.parse(data) : null;
      } catch(e){ return null; }
    }

    async function saveRemote(){
      if (!db) return false;
      try {
        await db.ref(DB_PATH).set(CARDS);
        return true;
      } catch(e) {
        console.warn("[Firebase] Falha ao salvar:", e.message || e);
        return false;
      }
    }

    async function loadRemote(){
      if (!db) return null;
      try {
        const snap = await db.ref(DB_PATH).get();
        return snap.exists() ? snap.val() : null;
      } catch(e) {
        console.warn("[Firebase] Falha ao carregar:", e.message || e);
        return null;
      }
    }

    // ========= QUALIDADE =========
    function getAvailableQualityLevels(player){
      try {
        const lvls = player.getAvailableQualityLevels?.() || [];
        return lvls.length ? lvls : Q_ORDER.slice(); // fallback
      } catch(e){ return Q_ORDER.slice(); }
    }

    function enforceQuality(player, desired){
      if (!player || !player.setPlaybackQuality) return;
      const avail = getAvailableQualityLevels(player);
      // se o desejado n√£o existir, pega o mais pr√≥ximo abaixo
      let pick = desired;
      if (!avail.includes(desired)) {
        const idx = Q_ORDER.indexOf(desired);
        for (let i = idx; i >= 0; i--) if (avail.includes(Q_ORDER[i])) { pick = Q_ORDER[i]; break; }
      }
      try { player.setPlaybackQuality(pick); } catch(e){}
    }

    // ========= RENDER =========
    function renderGrid(){
      const grid = qs("#grid");
      grid.innerHTML = "";

      if (!Array.isArray(CARDS.items) || CARDS.items.length === 0) {
        qs("#emptyState").classList.remove("hidden");
        return;
      } else {
        qs("#emptyState").classList.add("hidden");
      }

      CARDS.items.forEach((item, idx) => {
        const node = document.importNode(qs("#cardTpl").content, true).firstElementChild;

        node.dataset.idx = String(idx);
        node.querySelector(".title").textContent = item.label || `Stream ${idx+1}`;
        node.querySelector(".chip").textContent  = item.loc || "";
        node.querySelector(".q-select").value    = (item.quality || DEFAULT_QUALITY);

        const iframe = node.querySelector("iframe");
        iframe.id = `yt_${item.id}_${idx}_${uid()}`;

        const url = buildYouTubeEmbedURL(item.id, item.isPlaylist);
        iframe.src = url;

        // Modo editor: bot√µes e drag
        node.querySelector(".btn-remove").classList.toggle("hidden", MODE!=="edit");
        node.querySelector(".handle").classList.toggle("hidden", MODE!=="edit");
        if (MODE === "edit") attachDragHandlers(node);

        grid.appendChild(node);
      });

      // cria players quando API pronta
      if (YT_READY) createPlayers();
    }

    function buildYouTubeEmbedURL(id, isPlaylist){
      if (isPlaylist) {
        return `https://www.youtube.com/embed/videoseries?list=${encodeURIComponent(id)}&enablejsapi=1&controls=1&rel=0&modestbranding=1`;
      }
      // Se for link inteiro, tenta extrair
      if (/youtube\.com|youtu\.be/.test(id)) {
        const vid = extractVideoId(id);
        return `https://www.youtube.com/embed/${vid}?enablejsapi=1&controls=1&rel=0&modestbranding=1`;
      }
      // ID direto
      return `https://www.youtube.com/embed/${encodeURIComponent(id)}?enablejsapi=1&controls=1&rel=0&modestbranding=1`;
    }

    function extractVideoId(input){
      try {
        if (/^PL|^UU|^LL/i.test(input)) return input;
        const u = new URL(input);
        if (u.hostname.includes("youtu.be")) return u.pathname.replace("/","");
        const v = u.searchParams.get("v");
        return v || input;
      } catch(e){ return input; }
    }

    // ========= YT API HOOK =========
    window.onYouTubeIframeAPIReady = function(){
      YT_READY = true;
      createPlayers();
    };

    function createPlayers(){
      qsa("iframe[id^='yt_']").forEach((ifr, i) => {
        const idx = parseInt(ifr.closest(".video-card").dataset.idx,10);
        const item = CARDS.items[idx];
        try {
          const p = new YT.Player(ifr.id, {
            events: {
              onReady: (ev) => {
                PLAYERS[idx] = ev.target;
                // aplica qualidade inicial
                const desired = item.quality || DEFAULT_QUALITY;
                enforceQuality(ev.target, desired);
              },
              onStateChange: (ev) => {
                if (ev.data === YT.PlayerState.BUFFERING || ev.data === YT.PlayerState.PLAYING) {
                  const desired = item.quality || DEFAULT_QUALITY;
                  enforceQuality(ev.target, desired);
                }
              }
            }
          });
        } catch(e) {
          console.warn("YT Player error:", e?.message || e);
        }
      });
    }

    // ========= DRAG & DROP (modo editor) =========
    let dragIndex = null;

    function attachDragHandlers(cardEl){
      cardEl.setAttribute("draggable", "true");
      cardEl.addEventListener("dragstart", (e)=>{
        dragIndex = parseInt(cardEl.dataset.idx,10);
        cardEl.classList.add("dragging");
      });
      cardEl.addEventListener("dragend", ()=>{
        cardEl.classList.remove("dragging");
        dragIndex = null;
      });

      cardEl.addEventListener("dragover", (e)=>{
        e.preventDefault();
        const grid = qs("#grid");
        const afterEl = getDragAfterElement(grid, e.clientY);
        if (afterEl == null) {
          grid.appendChild(createGhost());
        } else {
          grid.insertBefore(createGhost(), afterEl);
        }
      });

      cardEl.addEventListener("drop", (e)=>{
        e.preventDefault();
        removeGhost();
        const grid = qs("#grid");
        const children = Array.from(grid.children);
        const targetIdx = children.indexOf(cardEl);
        if (dragIndex == null || targetIdx == null) return;
        if (dragIndex === targetIdx) return;
        const arr = CARDS.items.slice();
        const [moved] = arr.splice(dragIndex,1);
        arr.splice(targetIdx,0,moved);
        CARDS.items = arr;
        saveLocal();
        renderGrid();
      });

      // Bot√£o remover
      cardEl.querySelector(".btn-remove").addEventListener("click", ()=>{
        const idx = parseInt(cardEl.dataset.idx,10);
        if (idx > -1 && confirm("Remover esta stream?")) {
          CARDS.items.splice(idx,1);
          saveLocal();
          renderGrid();
        }
      });

      // Seletor de qualidade
      cardEl.querySelector(".q-select").addEventListener("change", (e)=>{
        const idx = parseInt(cardEl.dataset.idx,10);
        const val = e.target.value;
        CARDS.items[idx].quality = val;
        saveLocal();
        const p = PLAYERS[idx];
        enforceQuality(p, val);
        updateHUDQuality(idx, val);
      });
    }

    function updateHUDQuality(idx, val){
      const card = qsa(".video-card")[idx];
      if (!card) return;
      const chip = card.querySelector(".chip");
      const label = QUALITY_LABEL[val] || val;
      chip.textContent = `Qualidade: ${label}`;
    }

    function getDragAfterElement(container, y){
      const draggableElements = [...container.querySelectorAll(".video-card:not(.dragging)")];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child }
        } else {
          return closest
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function createGhost(){
      removeGhost();
      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.id = "ghost";
      return ghost;
    }
    function removeGhost(){
      const g = qs("#ghost");
      if (g) g.remove();
    }

    // ========= EDITOR BAR =========
    function editorInit(){
      if (MODE !== "edit") return;
      const addBtn = qs("#addBtn");
      const saveBtn = qs("#saveBtn");
      const clearBtn = qs("#clearBtn");

      addBtn.addEventListener("click", ()=>{
        const input = prompt("Cole um ID de v√≠deo (ex: dQw4w9WgXcQ) ou playlist (ex: PL...) ou uma URL do YouTube:");
        if (!input) return;
        const item = parseInputToItem(input.trim());
        CARDS.items.push(item);
        saveLocal();
        renderGrid();
      });

      saveBtn.addEventListener("click", async ()=>{
        const ok = await saveRemote();
        alert(ok ? "Layout salvo no Firebase." : "N√£o foi poss√≠vel salvar no Firebase (verifique a configura√ß√£o). O layout j√° est√° salvo localmente.");
      });

      clearBtn.addEventListener("click", ()=>{
        if (!confirm("Limpar todas as streams?")) return;
        CARDS.items = [];
        saveLocal();
        renderGrid();
      });
    }

    function parseInputToItem(input){
      // playlist?
      const isPL = /^PL|^UU|^LL/i.test(input) || /[?&]list=/.test(input);
      let id = input;
      let label = "";
      if (isPL) {
        if (/[?&]list=/.test(input)) {
          try { id = new URL(input).searchParams.get("list") || input; } catch(e){}
        }
      } else {
        // tenta extrair videoId se for URL
        id = extractVideoId(input);
      }
      label = isPL ? "Playlist" : "Live / V√≠deo";
      return { id, label, loc:"", isPlaylist: isPL, quality: DEFAULT_QUALITY };
    }

    // ========= BOOT =========
    async function boot(){
      setModeUI();

      // Estado inicial: tenta remoto, sen√£o local
      let state = await loadRemote();
      if (!state) {
        state = loadLocal();
        showOfflineBanner(!!state);
      }
      if (!state) {
        // estado base
        state = {
          cols: 2,
          items: [
            // Exemplo vazio ‚Äî adicione no modo editor
          ]
        };
      }
      CARDS = state;

      // Override de colunas por query
      applyGridCols();

      // Render inicial
      renderGrid();

      // Atualiza HUD de qualidade padr√£o
      qDefaultInfo.textContent = QUALITY_LABEL[DEFAULT_QUALITY] || DEFAULT_QUALITY;

      // Editor features
      editorInit();

      // Eventos globais (delega√ß√£o)
      qs("#grid").addEventListener("change", (e)=>{
        const sel = e.target.closest(".q-select");
        if (!sel) return;
        const card = e.target.closest(".video-card");
        if (!card) return;
        const idx = parseInt(card.dataset.idx,10);
        CARDS.items[idx].quality = sel.value;
        saveLocal();
        const p = PLAYERS[idx];
        enforceQuality(p, sel.value);
        updateHUDQuality(idx, sel.value);
      });
    }

    // Inicia
    boot();
  </script>
</body>
</html>
