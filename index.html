<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <!-- build: v13.2 - independência do visualizador -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card:#111827; }
    * { box-sizing: border-box; }
    body { background:#111827; color:white; }

    .grid-container { display:grid; gap:1rem; grid-template-columns:repeat(2,1fr); }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .grid-container{ grid-template-columns:1fr;} }

    .video-card{ background:#1f2937; border-radius:12px; overflow:hidden; border:1px solid #374151; }
    .video-box{ aspect-ratio:16/9; position:relative; }
    .player-fill{ position:absolute; inset:0; }
    .player-fill iframe{ width:100%!important; height:100%!important; display:block; }

    .badge-live{ background:#dc2626; }
    .tile-btn{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); }
    .tile-btn:hover{ background:rgba(255,255,255,.08); }
    .drag-over{ outline:2px dashed #60a5fa; outline-offset:-6px; }
    .hidden { display:none!important; }
    .controls { z-index:15; }

    /* OFFLINE overlay */
    .offline-overlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      text-align:center; padding:1rem;
      background:linear-gradient(180deg, rgba(17,24,39,0.25), rgba(17,24,39,0.85));
      backdrop-filter:blur(2px);
      pointer-events:none; z-index:9;
    }
    .offline-badge{
      display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem;
      border:1px solid rgba(255,255,255,.25); border-radius:.5rem; font-size:.9rem; color:#e5e7eb;
    }

    /* QUALIDADE */
    .q-wrap{ position:absolute; right:.5rem; bottom:.5rem; display:flex; align-items:center; gap:.4rem; z-index:20; }
    .q-btn{ display:flex; align-items:center; gap:.35rem; font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); cursor:pointer; }
    .q-btn:hover{ background:rgba(255,255,255,.08); }
    .q-menu{ position:absolute; right:0; bottom:2.2rem; background:#0b1220; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:.35rem; display:none; z-index:30; min-width:96px; }
    .q-item{ display:flex; align-items:center; gap:.45rem; padding:.35rem .5rem; border-radius:.45rem; font-size:12px; cursor:pointer; white-space:nowrap; }
    .q-item:hover{ background:rgba(255,255,255,.08); }
    .q-dot{ width:8px; height:8px; border-radius:999px; background:#60a5fa; opacity:.9; }
  </style>

  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);
    const qsa=(s,e=document)=>Array.from(e.querySelectorAll(s));

    /* ===== Login ===== */
    const AUTH_USER='OPERACAOCPM';
    const AUTH_PASS='CAVPMDRONES';
    const REMEMBER_MIN=240;

    function auth_ok_until(){ const v=localStorage.getItem('auth_ok_until'); return v?parseInt(v,10):0; }
    function set_auth_ok(){ localStorage.setItem('auth_ok_until', String(Date.now()+REMEMBER_MIN*60*1000)); }
    function doLogin(){
      const u=qs('#authUser')?.value?.trim()||'', p=qs('#authPass')?.value||'', err=qs('#authErr');
      if(u===AUTH_USER && p===AUTH_PASS){ set_auth_ok(); qs('#authOverlay').style.display='none'; return true; }
      err?.classList.remove('hidden'); setTimeout(()=>err?.classList.add('hidden'),1500); return false;
    }

    /* ===== Firebase ===== */
    const FIREBASE = {
      apiKey: "AIzaSyDadspZB30sQOgZr7PTcSbub1ZJB80Kui4",
      authDomain: "dashboarddronepmesp.firebaseapp.com",
      databaseURL: "https://dashboarddronepmesp-default-rtdb.firebaseio.com",
      projectId: "dashboarddronepmesp",
      storageBucket: "dashboarddronepmesp.firebasestorage.app",
      messagingSenderId: "769998411213",
      appId: "1:769998411213:web:f0ecce2126f0af9b4a2084",
      measurementId: "G-4TVLS703CF"
    };
    const DB_PATH='dashboards/main'; // usamos {ids,labels,locs,cols,main}

    firebase.initializeApp(FIREBASE);
    const db=firebase.database();
    const dbRef=db.ref(DB_PATH);

    /* ===== Estado & Params ===== */
    const params=new URLSearchParams(location.search);
    const MODE=(params.get('mode')||'edit').toLowerCase();
    const isView = MODE==='view';
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIEW_COLS_OVERRIDE=null;

    let VIDEO_IDS=[], LABELS=[], LOCS=[];
    let MAIN_ID=null; // id da live principal
    let YT_READY=false;

    // players secundários por índice e player principal
    const players = {};
    let mainPlayer = null;

    /* ===== Qualidade ===== */
    const DEFAULT_QUALITY='tiny'; // 144p
    const Q_KEY_PREFIX='liveQ_';
    const Q_ORDER=['tiny','small','medium','large','hd720','hd1080','highres'];
    const Q_LABEL={tiny:'144p',small:'240p',medium:'360p',large:'480p',hd720:'720p',hd1080:'1080p',highres:'Máx.'};

    function getSavedQ(id){ return localStorage.getItem(Q_KEY_PREFIX+id); }
    function saveQ(id,q){ localStorage.setItem(Q_KEY_PREFIX+id,q); }

    function pickAvailableQuality(requested, available){
      const avail=new Set(available||[]);
      if (avail.has(requested)) return requested;
      const idx=Q_ORDER.indexOf(requested);
      if (idx>=0){ for(let i=idx;i>=0;i--) if (avail.has(Q_ORDER[i])) return Q_ORDER[i]; }
      for(const q of Q_ORDER) if (avail.has(q)) return q;
      return requested;
    }
    function enforceQuality(player, desired, cycles=10, interval=500){
      let n=0; const iv=setInterval(()=>{
        try{
          const avail=player.getAvailableQualityLevels?player.getAvailableQualityLevels():[];
          const best=pickAvailableQuality(desired, avail);
          if (player.setPlaybackQuality) player.setPlaybackQuality(best);
        }catch(_){}
        if(++n>=cycles) clearInterval(iv);
      }, interval);
    }

    /* ===== Utils ===== */
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const idFromUrl=u=>{
      try{
        const url=new URL(u);
        const list=url.searchParams.get('list');
        if(list) return list; // playlist
        const v=url.searchParams.get('v');
        if(v) return v;       // vídeo
        if(url.hostname.includes('youtu.be')) return url.pathname.slice(1);
      }catch(_){}
      if(typeof u==='string'){
        if(u.includes('list=')) return u.split('list=')[1].split('&')[0];
        if(u.includes('watch?v=')) return u.split('v=')[1].split('&')[0];
      }
      return (u||'').trim();
    };
    const isPlaylistId=(id)=> typeof id==='string' && (id.startsWith('PL')||id.startsWith('UU')||id.startsWith('LL')||id.length>12);

    /* ===== Drag & Drop (editor) ===== */
    let dragSrcIndex=null;
    function attachDnD(cardEl){
      if(isView) return;
      cardEl.setAttribute('draggable','true');
      cardEl.addEventListener('dragstart', e=>{
        dragSrcIndex=parseInt(cardEl.dataset.idx,10);
        e.dataTransfer.effectAllowed='move';
        cardEl.classList.add('opacity-80');
      });
      cardEl.addEventListener('dragend',   ()=>{
        dragSrcIndex=null;
        cardEl.classList.remove('opacity-80');
        qsa('.drag-over').forEach(x=>x.classList.remove('drag-over'));
      });
      cardEl.addEventListener('dragover',  e=>{
        e.preventDefault(); e.dataTransfer.dropEffect='move'; cardEl.classList.add('drag-over');
      });
      cardEl.addEventListener('dragleave', ()=>{ cardEl.classList.remove('drag-over'); });
      cardEl.addEventListener('drop',      e=>{
        e.preventDefault(); cardEl.classList.remove('drag-over');
        const targetIndex=parseInt(cardEl.dataset.idx,10);
        if(dragSrcIndex===null || dragSrcIndex===targetIndex) return;
        const move=(arr,from,to)=>{ const x=arr.splice(from,1)[0]; arr.splice(to,0,x); };
        move(VIDEO_IDS,dragSrcIndex,targetIndex);
        move(LABELS,   dragSrcIndex,targetIndex);
        move(LOCS,     dragSrcIndex,targetIndex);
        saveRealtime();
        renderAll();
      });
    }

    /* ===== ★ Independência do visualizador ===== */
    const VIEW_MAIN_KEY = 'viewer_main_override';
    function getViewOverride(){ try{ return isView ? localStorage.getItem(VIEW_MAIN_KEY) : null; }catch(_){ return null; } }
    function setViewOverride(id){ try{ if(isView) localStorage.setItem(VIEW_MAIN_KEY, id||''); }catch(_){ } }
    function clearViewOverride(){ try{ localStorage.removeItem(VIEW_MAIN_KEY); }catch(_){ } }

    /* ===== YouTube ===== */
    window.onYouTubeIframeAPIReady=function(){ YT_READY=true; renderAll(); };

    function applyGridCols(){
      const cols = (isView && VIEW_COLS_OVERRIDE!=null) ? VIEW_COLS_OVERRIDE : COLS;
      const grid=qs('#gridContainer');
      if(grid) grid.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
      const layout=qs('#layout'); if(layout) layout.value=String(cols);
    }

    function qualityControlTemplate(currentLabel){
      return `
        <div class="q-wrap">
          <button type="button" class="q-btn" data-qbtn>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="opacity-90">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.89 3.31.877 2.42 2.42a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.89 1.543-.877 3.31-2.42 2.42a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.89-3.31-.877-2.42-2.42A1.724 1.724 0 004.317 13.65c-1.756-.426-1.756-2.924 0-3.35A1.724 1.724 0 005.383 7.73c-.89-1.543.877-3.31 2.42-2.42.99.57 2.232.04 2.522-.993z"/>
              <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
            </svg>
            <span data-qlabel>${currentLabel}</span>
          </button>
          <div class="q-menu" data-qmenu>
            ${Q_ORDER.map(q=>`
              <div class="q-item" data-q="${q}">
                <span class="q-dot"></span>${Q_LABEL[q]}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    /* ===== Botões globais (remover / qualidade / principal) ===== */
    document.addEventListener('click', (ev)=>{
      // remover (somente editor)
      const rmBtn = ev.target.closest('[data-remove]');
      if(rmBtn && !isView){
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        const idx = VIDEO_IDS.indexOf(id);
        if(idx>-1){
          if(!confirm('Remover esta equipe?')) return;
          VIDEO_IDS.splice(idx,1); LABELS.splice(idx,1); LOCS.splice(idx,1);
          if(MAIN_ID===id) MAIN_ID = VIDEO_IDS[0] || null; // se remover a principal
          saveRealtime();
          renderAll();
        }
        return;
      }

      // tornar principal (view e edit)
      const mainBtn = ev.target.closest('[data-setmain]');
      if(mainBtn){
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        setMain(id);
        return;
      }

      // abrir/fechar menu de qualidade
      const qBtn = ev.target.closest('[data-qbtn]');
      if(qBtn){
        const menu = qBtn.parentElement.querySelector('[data-qmenu]');
        const open = menu.style.display==='block';
        qsa('.q-menu').forEach(m=> m.style.display='none');
        menu.style.display = open ? 'none' : 'block';
        ev.stopPropagation();
        return;
      }

      // escolher qualidade
      const qItem = ev.target.closest('.q-item');
      if(qItem){
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        const idxAttr = card.getAttribute('data-idx'); // pode ser "main" ou número
        const q  = qItem.getAttribute('data-q');
        saveQ(id,q);

        if(idxAttr==='main' && mainPlayer){
          try{ mainPlayer.setPlaybackQuality(q); enforceQuality(mainPlayer,q); }catch(_){}
        }else{
          const idx = parseInt(idxAttr,10);
          const player = players[idx];
          try{ player && player.setPlaybackQuality && player.setPlaybackQuality(q); enforceQuality(player,q); }catch(_) {}
        }

        const lbl = card.querySelector('[data-qlabel]'); if(lbl) lbl.textContent = Q_LABEL[q]||q;
        const menu = card.querySelector('[data-qmenu]'); if(menu) menu.style.display='none';
        return;
      }

      // clique fora fecha menus
      const clickedInsideQ = ev.target.closest('.q-wrap');
      if(!clickedInsideQ){ qsa('.q-menu').forEach(m=> m.style.display='none'); }
    });

    /* ===== Render ===== */
    function renderAll(){
      renderMain();
      renderGrid();
    }

    function renderMain(){
      const cont = qs('#mainContainer');
      cont.innerHTML='';

      if(!VIDEO_IDS.length){
        cont.classList.add('hidden');
        return;
      }
      cont.classList.remove('hidden');

      // ★ usa override do viewer se existir (apenas em mode=view)
      const overrideId = getViewOverride();
      const id = (isView && overrideId && VIDEO_IDS.includes(overrideId))
        ? overrideId
        : ( (MAIN_ID && VIDEO_IDS.includes(MAIN_ID)) ? MAIN_ID : (VIDEO_IDS[0]||null) );

      if(!id){ cont.classList.add('hidden'); return; }

      const idx = VIDEO_IDS.indexOf(id);
      const label = LABELS[idx] || `Equipe ${idx+1}`;
      const loc   = LOCS[idx]   || '';
      const isPl  = isPlaylistId(id);
      const fullUrl = isPl ? `https://www.youtube.com/playlist?list=${encodeURIComponent(id)}` : `https://www.youtube.com/watch?v=${encodeURIComponent(id)}`;
      const savedQ = getSavedQ(id) || DEFAULT_QUALITY;

      const card = document.createElement('div');
      card.className='video-card';
      card.dataset.vid=id;
      card.dataset.idx='main';

      card.innerHTML = `
        <div class="video-box">
          <div id="yt_main" class="player-fill"></div>

          <div class="absolute top-2 left-2 flex gap-2 controls">
            <button class="tile-btn" data-setmain>Principal</button>
          </div>

          <div class="absolute top-2 right-2 flex gap-2 controls">
            <button class="tile-btn" onclick="window.open('${fullUrl}','_blank')">Tela cheia</button>
            ${isView ? '' : `<button class="tile-btn" data-remove>Remover</button>`}
          </div>

          <div class="absolute top-2 left-24 px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">
            <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO (Principal)
          </div>

          <div class="offline-overlay" id="off_main">
            <div class="offline-badge">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12H3"/></svg>
              <span>OFFLINE • aguardando sinal</span>
            </div>
          </div>

          ${qualityControlTemplate(Q_LABEL[savedQ])}
        </div>

        <div class="px-3 pt-2 pb-3 bg-gray-800/70">
          <h3 class="font-semibold text-base">${esc(label)}</h3>
          <p class="text-gray-400 text-sm">${esc(loc)}</p>
        </div>
      `;
      cont.appendChild(card);

      if(YT_READY){
        const cfg = {
          width:'100%', height:'100%',
          playerVars:{ autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
          events:{
            onReady:e=>onPlayerReadyMain(e, id),
            onStateChange:e=>onPlayerStateChangeMain(e)
          }
        };
        if(isPl){ cfg.playerVars.listType='playlist'; cfg.playerVars.list=id; } else { cfg.videoId=id; }
        mainPlayer = new YT.Player('yt_main', cfg);
      }
    }

    function renderGrid(){
      const grid=qs('#gridContainer');
      grid.innerHTML='';
      applyGridCols();

      if(!VIDEO_IDS.length){
        grid.innerHTML=isView?'Aguardando configuração do operador.':'Clique em <b>Inserir Equipe</b> no topo.';
        return;
      }

      const idsForGrid = VIDEO_IDS.filter(id => id !== ( (MAIN_ID&&VIDEO_IDS.includes(MAIN_ID))?MAIN_ID:(VIDEO_IDS[0]||null) ));

      if(LABELS.length<VIDEO_IDS.length){ for(let i=LABELS.length;i<VIDEO_IDS.length;i++) LABELS[i]=`Equipe ${String(i+1).padStart(2,'0')}`; }
      if(LOCS.length<VIDEO_IDS.length){   for(let i=LOCS.length;i<VIDEO_IDS.length;i++)   LOCS[i]=''; }

      idsForGrid.forEach((id,i)=>{
        const idxOriginal = VIDEO_IDS.indexOf(id);
        const savedQ = getSavedQ(id) || DEFAULT_QUALITY;
        const isPl=isPlaylistId(id);
        const fullUrl = isPl ? `https://www.youtube.com/playlist?list=${encodeURIComponent(id)}` : `https://www.youtube.com/watch?v=${encodeURIComponent(id)}`;

        const card=document.createElement('div');
        card.className='video-card';
        card.dataset.idx=String(i);
        card.dataset.vid=id;
        card.id=`card_${i}`;

        card.innerHTML=
          `<div class="video-box">
             <div id="yt_${i}" class="player-fill"></div>

             <div class="absolute top-2 left-2 flex gap-2 controls">
               <button class="tile-btn" data-setmain>Tornar principal</button>
             </div>

             <div class="absolute top-2 right-2 flex gap-2 controls">
               <button class="tile-btn" onclick="window.open('${fullUrl}','_blank')">Tela cheia</button>
               ${isView ? '' : `<button class="tile-btn" data-remove>Remover</button>`}
             </div>

             <div class="absolute top-2 left-40 px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">
               <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO
             </div>

             <div class="offline-overlay" id="off_${i}">
               <div class="offline-badge">
                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12H3"/></svg>
                 <span>OFFLINE • aguardando sinal</span>
               </div>
             </div>

             ${qualityControlTemplate(Q_LABEL[savedQ])}
           </div>

           <div class="px-2 pt-1 pb-2 bg-gray-800/70">
             <h3 class="font-medium text-sm">${esc(LABELS[idxOriginal]||'Equipe '+(idxOriginal+1))}</h3>
             <p class="text-gray-400 text-[11px]">${esc(LOCS[idxOriginal]||'')}</p>
           </div>`;

        grid.appendChild(card);
        attachDnD(card);

        if(YT_READY){
          const playerConfig = {
            width:'100%', height:'100%',
            playerVars:{ autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
            events:{ onReady:e=>onPlayerReadyGrid(e, id, i), onStateChange:e=>onPlayerStateChangeGrid(e, i) }
          };
          if(isPl){ playerConfig.playerVars.listType='playlist'; playerConfig.playerVars.list=id; }
          else { playerConfig.videoId=id; }
          players[i] = new YT.Player(`yt_${i}`, playerConfig);
        }
      });
    }

    /* ===== OFFLINE ===== */
    const OFFLINE_POLL_MS = 10000;

    function setOfflineEl(elId, flag){
      const ov = document.getElementById(elId);
      if(ov) ov.style.display = flag ? 'flex' : 'none';
    }

    // Principal
    function onPlayerReadyMain(e, id){
      try{ e.target.mute(); e.target.playVideo(); }catch(_){}
      const desired=getSavedQ(id) || DEFAULT_QUALITY;
      const avail=e.target.getAvailableQualityLevels?e.target.getAvailableQualityLevels():[];
      const best=pickAvailableQuality(desired, avail);
      try{ e.target.setPlaybackQuality && e.target.setPlaybackQuality(best); }catch(_){}
      enforceQuality(e.target, best);
      const lbl=qs('#mainContainer [data-qlabel]'); if(lbl) lbl.textContent=Q_LABEL[best]||best;
      if(!getSavedQ(id)) saveQ(id, best);
      setOfflineEl('off_main', true);
    }
    function onPlayerStateChangeMain(e){
      if (typeof YT!=='undefined' && YT.PlayerState){
        const online = (e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.BUFFERING);
        setOfflineEl('off_main', !online);
      }
    }

    // Grid
    function onPlayerReadyGrid(e, id, idx){
      try{ e.target.mute(); e.target.playVideo(); }catch(_){}
      const desired=getSavedQ(id) || DEFAULT_QUALITY;
      const avail=e.target.getAvailableQualityLevels?e.target.getAvailableQualityLevels():[];
      const best=pickAvailableQuality(desired, avail);
      try{ e.target.setPlaybackQuality && e.target.setPlaybackQuality(best); }catch(_){}
      enforceQuality(e.target, best);
      const card=qs(`#card_${idx}`);
      const lbl=card?.querySelector('[data-qlabel]'); if(lbl) lbl.textContent=Q_LABEL[best]||best;
      if(!getSavedQ(id)) saveQ(id, best);
      setOfflineEl(`off_${idx}`, true);
    }
    function onPlayerStateChangeGrid(e, idx){
      if (typeof YT!=='undefined' && YT.PlayerState){
        const online = (e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.BUFFERING);
        setOfflineEl(`off_${idx}`, !online);
      }
    }

    // Poll para manter overlays sincronizados
    setInterval(()=>{
      if(mainPlayer && typeof YT!=='undefined' && YT.PlayerState){
        try{ const st = mainPlayer.getPlayerState ? mainPlayer.getPlayerState() : null;
          if(st!=null){ const on = (st===YT.PlayerState.PLAYING || st===YT.PlayerState.BUFFERING); setOfflineEl('off_main', !on); }
        }catch(_){}
      }
      Object.keys(players).forEach(k=>{
        const i = Number(k);
        const p = players[i];
        if(!p || typeof YT==='undefined' || !YT.PlayerState) return;
        try{
          const st = p.getPlayerState ? p.getPlayerState() : null;
          if(st!=null){ const on=(st===YT.PlayerState.PLAYING || st===YT.PlayerState.BUFFERING); setOfflineEl(`off_${i}`, !on); }
        }catch(_){}
      });
    }, OFFLINE_POLL_MS);

    /* ===== Realtime ===== */
    function saveRealtime(){
      // salvamos tudo, incluindo MAIN_ID
      dbRef.set({ ids:VIDEO_IDS, labels:LABELS, locs:LOCS, cols:COLS, main: MAIN_ID || null, ts:Date.now() });
    }

    // ★ em view: só local; em edit: atualiza Firebase
    function setMain(id){
      if(isView){
        setViewOverride(id);           // salva a preferência deste viewer
        renderAll();
        window.scrollTo({top:0, behavior:'smooth'});
      }else{
        MAIN_ID = id;
        dbRef.update({ main: id, ts:Date.now() });
        renderAll();
      }
    }

    function subscribeRealtime(){
      dbRef.on('value', snap=>{
        const j=snap.val(); if(!j) return;
        const newIds=j.ids||[], newLabels=j.labels||[], newLocs=j.locs||[];
        COLS = parseInt(j.cols||COLS||2,10);
        MAIN_ID = j.main || MAIN_ID || newIds[0] || null;

        VIDEO_IDS=newIds.slice(); LABELS=newLabels.slice(); LOCS=newLocs.slice();
        renderAll(); // respeita override local automaticamente em renderMain()
      });
    }

    /* ===== UI Init ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Mostrar/ocultar botões conforme modo
      qs('#btnShare')?.classList.toggle('hidden', isView);
      qs('#btnConfig')?.classList.toggle('hidden', isView);
      qs('#btnClearAll')?.classList.toggle('hidden', isView);

      // LOGIN
      if(auth_ok_until()<=Date.now()){
        qs('#authOverlay').style.display='flex';
        qs('#authForm')?.addEventListener('submit', e=>{ e.preventDefault(); doLogin(); });
      } else { qs('#authOverlay').style.display='none'; }

      // Cabeçalho
      qs('#btnFullscreen')?.addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });

      // Layout select:
      qs('#layout')?.addEventListener('change', ()=>{
        const val = parseInt(qs('#layout').value,10)||2;
        if(isView){ VIEW_COLS_OVERRIDE = val; applyGridCols(); }
        else { COLS = val; saveRealtime(); applyGridCols(); }
      });

      // Inserir equipe (editor)
      qs('#btnAddTeam')?.addEventListener('click', e=>{
        e.preventDefault();
        const name=qs('#teamName').value.trim();
        const loc=qs('#teamLocation').value.trim();
        const url=qs('#youtubeUrl').value.trim();
        if(!name||!url){ alert('Preencha Nome e URL'); return; }
        const id=idFromUrl(url);
        VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);
        if(!getSavedQ(id)) saveQ(id, DEFAULT_QUALITY);
        if(!MAIN_ID) MAIN_ID = id; // define primeira como principal
        saveRealtime();
        renderAll();
        qs('#configModal').classList.add('hidden'); qs('#teamForm').reset();
      });

      // Share link (editor)
      qs('#btnShare')?.addEventListener('click', ()=>{
        const base=location.origin+location.pathname;
        const url=new URL(base);
        url.searchParams.set('mode','view');
        url.searchParams.set('cols', String(COLS));
        url.searchParams.set('sync','rt');
        navigator.clipboard.writeText(url.toString()).then(()=>alert('Link do VISUALIZADOR copiado:\n\n'+url.toString()));
      });

      // Limpar tudo (editor)
      qs('#btnClearAll')?.addEventListener('click', ()=>{
        if(!confirm('Apagar TODAS as equipes do dashboard?')) return;
        VIDEO_IDS=[]; LABELS=[]; LOCS=[]; MAIN_ID=null;
        saveRealtime();
        renderAll();
      });

      // Start RT e primeira render
      subscribeRealtime();
    });

    // Garante definição única global
    window.onYouTubeIframeAPIReady=function(){ YT_READY=true; renderAll(); };
  })();
  </script>
</head>
<body class="min-h-screen">

  <!-- Overlay de Login -->
  <div id="authOverlay" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/70">
    <div class="bg-gray-800 text-white w-full max-w-sm rounded-xl shadow-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Acesso restrito</h2>
      <form id="authForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Usuário</label>
          <input id="authUser" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="usuário">
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="authPass" type="password" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="senha">
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Entrar</button>
        <p id="authErr" class="text-red-400 text-sm hidden">Usuário ou senha incorretos.</p>
      </form>
    </div>
  </div>

<header class="p-4 bg-gray-900 border-b border-gray-700 sticky top-0 z-40">
  <div class="max-w-7xl mx-auto flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
    <!-- Esquerda: Logo PMESP + Título + Logo CAVPM -->
    <div class="flex items-center gap-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Logo_PMESP.png"
           alt="PMESP"
           class="w-10 h-10 object-contain rounded bg-white/5 p-1">

      <div class="flex items-center gap-3">
        <div>
          <h1 class="text-lg font-bold">Dashboard Programa de Policiamento com Drones</h1>
          <p class="text-gray-400 text-xs">Monitoramento em Tempo Real • Firebase RT</p>
        </div>

        <!-- Logo CAVPM no ponto marcado em vermelho -->
        <img src="logo-cavpm.png"
             alt="Comando de Aviação da PMESP"
             class="w-10 h-10 object-contain rounded bg-white/5 p-1 ml-1">
      </div>
    </div>

    <!-- Direita: controles -->
    <div class="flex items-center gap-2">
      <label class="text-xs text-gray-400">Layout</label>
      <select id="layout" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
        <option value="2">2 colunas</option>
        <option value="3">3 colunas</option>
        <option value="4">4 colunas</option>
      </select>
      <button id="btnFullscreen" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Tela Cheia</button>
      <button id="btnShare" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Gerar Link</button>
      <button id="btnConfig" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm"
              onclick="document.getElementById('configModal').classList.remove('hidden')">
        Inserir Equipe
      </button>
      <button id="btnClearAll" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">
        Limpar
      </button>
    </div>
  </div>
</header>


  <!-- Principal -->
  <section class="max-w-7xl mx-auto p-4">
    <div id="mainContainer" class="video-card hidden"></div>
  </section>

  <!-- Grid secundário -->
  <main class="p-4 max-w-7xl mx-auto">
    <div id="gridContainer" class="grid-container"></div>
  </main>

  <!-- Modal Inserir -->
  <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4 text-center">Inserir Equipe</h3>
        <form id="teamForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Nome da Equipe</label>
            <input id="teamName" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Ex.: Equipe Alfa">
          </div>
          <div>
            <label class="block text-sm mb-1">Endereço da Operação</label>
            <input id="teamLocation" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Av. Olavo Fontoura, 1078">
          </div>
          <div>
            <label class="block text-sm mb-1">URL da Playlist/Vídeo</label>
            <input id="youtubeUrl" type="url" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="https://www.youtube.com/playlist?list=PLxxx ou https://www.youtube.com/watch?v=abc123">
          </div>
          <div class="flex gap-3 pt-2">
            <button id="btnAddTeam" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded">Adicionar</button>
            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded"
              onclick="document.getElementById('configModal').classList.add('hidden'); document.getElementById('teamForm').reset();">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>
</html>
