<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <!-- build: v12 - playlist + OFFLINE + qualidade + remover fix -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card:#111827; }
    * { box-sizing: border-box; }
    body { background:#111827; color:white; }

    .grid-container { display:grid; gap:1rem; grid-template-columns:repeat(2,1fr); }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .grid-container{ grid-template-columns:1fr;} }

    .video-card{ background:#1f2937; border-radius:12px; overflow:hidden; border:1px solid #374151; }
    .video-box{ aspect-ratio:16/9; position:relative; cursor:move; }
    .player-fill{ position:absolute; inset:0; }
    .player-fill iframe{ width:100%!important; height:100%!important; display:block; }

    .badge-live{ background:#dc2626; }
    .tile-btn{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; }
    .tile-btn:hover{ background:rgba(255,255,255,.08); }
    .drag-over{ outline:2px dashed #60a5fa; outline-offset:-6px; }
    .hidden { display:none!important; }

    .offline-overlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      text-align:center; padding:1rem;
      background:linear-gradient(180deg, rgba(17,24,39,0.25), rgba(17,24,39,0.85));
      backdrop-filter:blur(2px);
      pointer-events:none; z-index:9;
    }
    .offline-badge{
      display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem;
      border:1px solid rgba(255,255,255,.25); border-radius:.5rem; font-size:.9rem; color:#e5e7eb;
    }

    .q-wrap{ position:absolute; right:.5rem; bottom:.5rem; display:flex; align-items:center; gap:.4rem; z-index:12; }
    .q-btn{ display:flex; align-items:center; gap:.35rem; font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); cursor:pointer; }
    .q-btn:hover{ background:rgba(255,255,255,.08); }
    .q-menu{ position:absolute; right:0; bottom:2.2rem; background:#0b1220; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:.35rem; display:none; z-index:20; min-width:96px; }
    .q-item{ display:flex; align-items:center; gap:.45rem; padding:.35rem .5rem; border-radius:.45rem; font-size:12px; cursor:pointer; white-space:nowrap; }
    .q-item:hover{ background:rgba(255,255,255,.08); }
    .q-dot{ width:8px; height:8px; border-radius:999px; background:#60a5fa; opacity:.9; }

    .controls { z-index:15; }
  </style>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);
    const qsa=(s,e=document)=>Array.from(e.querySelectorAll(s));

    /* ===== Firebase ===== */
    const FIREBASE = {
      apiKey: "AIzaSyDadspZB30sQOgZr7PTcSbub1ZJB80Kui4",
      authDomain: "dashboarddronepmesp.firebaseapp.com",
      databaseURL: "https://dashboarddronepmesp-default-rtdb.firebaseio.com",
      projectId: "dashboarddronepmesp",
      storageBucket: "dashboarddronepmesp.firebasestorage.app",
      messagingSenderId: "769998411213",
      appId: "1:769998411213:web:f0ecce2126f0af9b4a2084",
      measurementId: "G-4TVLS703CF"
    };
    const DB_PATH='dashboards/main';

    firebase.initializeApp(FIREBASE);
    const db=firebase.database();
    const dbRef=db.ref(DB_PATH);

    const params=new URLSearchParams(location.search);
    const MODE=(params.get('mode')||'edit').toLowerCase();
    const isView = MODE==='view';
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIEW_COLS_OVERRIDE=null;

    let VIDEO_IDS=[], LABELS=[], LOCS=[];
    let YT_READY=false;
    const players = {};

    const DEFAULT_QUALITY='tiny';
    const Q_KEY_PREFIX='liveQ_';
    const Q_ORDER=['tiny','small','medium','large','hd720','hd1080','highres'];
    const Q_LABEL={tiny:'144p',small:'240p',medium:'360p',large:'480p',hd720:'720p',hd1080:'1080p',highres:'Máx.'};

    function getSavedQ(id){ return localStorage.getItem(Q_KEY_PREFIX+id); }
    function saveQ(id,q){ localStorage.setItem(Q_KEY_PREFIX+id,q); }

    function pickAvailableQuality(requested, available){
      const avail=new Set(available||[]);
      if (avail.has(requested)) return requested;
      const idx=Q_ORDER.indexOf(requested);
      if (idx>=0){
        for(let i=idx;i>=0;i--) if (avail.has(Q_ORDER[i])) return Q_ORDER[i];
      }
      for(const q of Q_ORDER) if (avail.has(q)) return q;
      return requested;
    }
    function enforceQuality(player, desired, cycles=10, interval=500){
      let n=0; const iv=setInterval(()=>{
        try{
          const avail=player.getAvailableQualityLevels?player.getAvailableQualityLevels():[];
          const best=pickAvailableQuality(desired, avail);
          if (player.setPlaybackQuality) player.setPlaybackQuality(best);
        }catch(_){}
        if(++n>=cycles) clearInterval(iv);
      }, interval);
    }

    const esc=s=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const idFromUrl=u=>{
      try{
        const url=new URL(u);
        const list=url.searchParams.get('list');
        if(list) return list;
        const v=url.searchParams.get('v');
        if(v) return v;
        if(url.hostname.includes('youtu.be')) return url.pathname.slice(1);
      }catch(_){}
      if(typeof u==='string'){
        if(u.includes('list=')) return u.split('list=')[1].split('&')[0];
        if(u.includes('watch?v=')) return u.split('v=')[1].split('&')[0];
      }
      return (u||'').trim();
    };
    const isPlaylistId=(id)=> typeof id==='string' && (id.startsWith('PL')||id.startsWith('UU')||id.startsWith('LL')||id.length>12);

    let dragSrcIndex=null;
    function attachDnD(cardEl){
      if(isView) return;
      cardEl.setAttribute('draggable','true');
      cardEl.addEventListener('dragstart', e=>{
        dragSrcIndex=parseInt(cardEl.dataset.idx,10);
        e.dataTransfer.effectAllowed='move';
        cardEl.classList.add('opacity-80');
      });
      cardEl.addEventListener('dragend',   ()=>{
        dragSrcIndex=null;
        cardEl.classList.remove('opacity-80');
        qsa('.drag-over').forEach(x=>x.classList.remove('drag-over'));
      });
      cardEl.addEventListener('dragover',  e=>{
        e.preventDefault(); e.dataTransfer.dropEffect='move'; cardEl.classList.add('drag-over');
      });
      cardEl.addEventListener('dragleave', ()=>{ cardEl.classList.remove('drag-over'); });
      cardEl.addEventListener('drop',      e=>{
        e.preventDefault(); cardEl.classList.remove('drag-over');
        const targetIndex=parseInt(cardEl.dataset.idx,10);
        if(dragSrcIndex===null || dragSrcIndex===targetIndex) return;
        const move=(arr,from,to)=>{ const x=arr.splice(from,1)[0]; arr.splice(to,0,x); };
        move(VIDEO_IDS,dragSrcIndex,targetIndex);
        move(LABELS,   dragSrcIndex,targetIndex);
        move(LOCS,     dragSrcIndex,targetIndex);
        saveRealtime();
        renderGrid();
      });
    }

    window.onYouTubeIframeAPIReady=function(){ YT_READY=true; renderGrid(); };

    function applyGridCols(){
      const cols = (isView && VIEW_COLS_OVERRIDE!=null) ? VIEW_COLS_OVERRIDE : COLS;
      const grid=qs('#gridContainer');
      if(grid) grid.style.gridTemplateColumns=repeat(${cols}, 1fr);
      const layout=qs('#layout'); if(layout) layout.value=String(cols);
    }

    function qualityControlTemplate(currentLabel){
      return `
        <div class="q-wrap">
          <button type="button" class="q-btn" data-qbtn>
            ⚙ <span data-qlabel>${currentLabel}</span>
          </button>
          <div class="q-menu" data-qmenu>
            ${Q_ORDER.map(q=>`
              <div class="q-item" data-q="${q}">
                <span class="q-dot"></span>${Q_LABEL[q]}
              </div>
            `).join('')}
          </div>
        </div>`;
    }

    document.addEventListener('click', (ev)=>{
      const rmBtn = ev.target.closest('[data-remove]');
      if(rmBtn && !isView){
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        const idx = VIDEO_IDS.indexOf(id);
        if(idx>-1){
          if(!confirm('Remover esta equipe?')) return;
          VIDEO_IDS.splice(idx,1); LABELS.splice(idx,1); LOCS.splice(idx,1);
          saveRealtime(); renderGrid();
        }
        return;
      }
      const qBtn = ev.target.closest('[data-qbtn]');
      if(qBtn){
        const menu = qBtn.parentElement.querySelector('[data-qmenu]');
        const open = menu.style.display==='block';
        qsa('.q-menu').forEach(m=> m.style.display='none');
        menu.style.display = open ? 'none' : 'block';
        ev.stopPropagation();
        return;
      }
      const qItem = ev.target.closest('.q-item');
      if(qItem){
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        const idx = parseInt(card.getAttribute('data-idx'),10);
        const q  = qItem.getAttribute('data-q');
        saveQ(id,q);
        const player = players[idx];
        try{ player && player.setPlaybackQuality && player.setPlaybackQuality(q); enforceQuality(player,q); }catch(_) {}
        const lbl = card.querySelector('[data-qlabel]'); if(lbl) lbl.textContent = Q_LABEL[q]||q;
        const menu = card.querySelector('[data-qmenu]'); if(menu) menu.style.display='none';
        return;
      }
      const clickedInsideQ = ev.target.closest('.q-wrap');
      if(!clickedInsideQ){ qsa('.q-menu').forEach(m=> m.style.display='none'); }
    });

    function renderGrid(){
      const grid=qs('#gridContainer');
      grid.innerHTML='';
      applyGridCols();

      if(LABELS.length<VIDEO_IDS.length){ for(let i=LABELS.length;i<VIDEO_IDS.length;i++) LABELS[i]=Equipe ${String(i+1).padStart(2,'0')}; }
      if(LOCS.length<VIDEO_IDS.length){   for(let i=LOCS.length;i<VIDEO_IDS.length;i++)   LOCS[i]=''; }

      if(!VIDEO_IDS.length){
        grid.innerHTML=isView?'Aguardando configuração do operador.':'Clique em <b>Inserir Equipe</b> no topo.';
        return;
      }

      VIDEO_IDS.forEach((id,i)=>{
        const savedQ = getSavedQ(id) || DEFAULT_QUALITY;
        const isPl=isPlaylistId(id);
        const fullUrl = isPl ? https://www.youtube.com/playlist?list=${encodeURIComponent(id)} : https://www.youtube.com/watch?v=${encodeURIComponent(id)};
        const card=document.createElement('div');
        card.className='video-card';
        card.dataset.idx=String(i);
        card.dataset.vid=id;
        card.id=card_${i};
        card.innerHTML=`
          <div class="video-box">
             <div id="yt_${i}" class="player-fill"></div>
             <div class="absolute top-2 left-2 px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">
               <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO
             </div>
             <div class="absolute top-2 right-2 flex gap-2 controls">
               <button class="tile-btn" onclick="window.open('${fullUrl}','_blank')">Tela cheia</button>
               ${isView ? '' : <button class="tile-btn" data-remove>Remover</button>}
             </div>
             <div class="offline-overlay" id="off_${i}">
               <div class="offline-badge">OFFLINE • aguardando sinal</div>
             </div>
             ${qualityControlTemplate(Q_LABEL[savedQ])}
           </div>
           <div class="px-2 pt-1 pb-0 bg-gray-800/70">
             <h3 class="font-medium text-sm">${esc(LABELS[i]||'Equipe '+(i+1))}</h3>
             <p class="text-gray-400 text-[11px]">${esc(LOCS[i]||'')}</p>
           </div>`;
        grid.appendChild(card);
        attachDnD(card);
        if(YT_READY){
          const cfg={width:'100%',height:'100%',playerVars:{autoplay:1,mute:1,playsinline:1,controls:0,rel:0,modestbranding:1},
            events:{onReady:e=>{try{e.target.mute();e.target.playVideo();}catch(_){}
              const desired=getSavedQ(id)||DEFAULT_QUALITY; enforceQuality(e.target,desired);
              const lbl=card.querySelector('[data-qlabel]'); if(lbl) lbl.textContent=Q_LABEL[desired]||desired;},
              onStateChange:e=>{
                const online=(e.data===1||e.data===3);
                const ov=document.getElementById('off_'+i);
                if(ov) ov.style.display=online?'none':'flex';
              }}};
          if(isPl){cfg.playerVars.listType='playlist';cfg.playerVars.list=id;} else {cfg.videoId=id;}
          players[i]=new YT.Player(yt_${i},cfg);
        }
      });
    }

    function saveRealtime(){ dbRef.set({ ids:VIDEO_IDS, labels:LABELS, locs:LOCS, cols:COLS, ts:Date.now() }); }
    function subscribeRealtime(){
      dbRef.on('value', snap=>{
        const j=snap.val(); if(!j) return;
        VIDEO_IDS=j.ids||[]; LABELS=j.labels||[]; LOCS=j.locs||[];
        COLS=parseInt(j.cols||COLS||2,10);
        renderGrid();
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      qs('#btnShare')?.classList.toggle('hidden', isView);
      qs('#btnConfig')?.classList.toggle('hidden', isView);
      qs('#btnClearAll')?.classList.toggle('hidden', isView);
      qs('#btnFullscreen')?.addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });
      qs('#layout')?.addEventListener('change', ()=>{
        const val=parseInt(qs('#layout').value,10)||2;
        if(isView){ VIEW_COLS_OVERRIDE=val; applyGridCols(); }
        else{ COLS=val; saveRealtime(); applyGridCols(); }
      });
      qs('#btnAddTeam')?.addEventListener('click', e=>{
        e.preventDefault();
        const name=qs('#teamName').value.trim();
        const loc=qs('#teamLocation').value.trim();
        const url=qs('#youtubeUrl').value.trim();
        if(!name||!url){ alert('Preencha Nome e URL'); return; }
        const id=idFromUrl(url);
        VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);
        if(!getSavedQ(id)) saveQ(id, DEFAULT_QUALITY);
        saveRealtime(); renderGrid();
        qs('#configModal').classList.add('hidden'); qs('#teamForm').reset();
      });
      qs('#btnShare')?.addEventListener('click', ()=>{
        const base=location.origin+location.pathname;
        const url=new URL(base);
        url.searchParams.set('mode','view');
        url.searchParams.set('cols', String(COLS));
        url.searchParams
