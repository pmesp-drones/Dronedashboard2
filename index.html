<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <!-- build: v15.5 - viewer restrito + inserir equipe fix + rename CPA estável -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://i.ytimg.com">
  <link rel="preconnect" href="https://s.ytimg.com">

  <style>
    :root { --card:#111827; }
    * { box-sizing: border-box; }
    body { background:#111827; color:white; }

    .grid-container { display:grid; gap:1rem; grid-template-columns:repeat(2,1fr); }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .grid-container{ grid-template-columns:1fr;} }

    .video-card{ background:#1f2937; border-radius:12px; overflow:hidden; border:1px solid #374151; }
    .video-box{ aspect-ratio:16/9; position:relative; }
    .player-fill{ position:absolute; inset:0; }
    .player-fill iframe{ width:100%!important; height:100%!important; display:block; }

    .thumb { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; cursor:default; }
    .thumb img{ width:100%; height:100%; object-fit:cover; filter:brightness(.92); }

    .tile-btn{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); }
    .tile-btn:hover{ background:rgba(255,255,255,.08); }
    .hidden { display:none!important; }
    .controls { z-index:15; }

    .offline-overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      text-align:center; padding:1rem;
      background:linear-gradient(180deg, rgba(17,24,39,0.20), rgba(17,24,39,0.75));
      backdrop-filter:blur(1.5px);
      pointer-events:none; z-index:9;
    }
    .offline-badge{
      display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem;
      border:1px solid rgba(255,255,255,.25); border-radius:.5rem; font-size:.9rem; color:#e5e7eb;
    }

    .live-badge{
      position:absolute; top:.5rem; left:.5rem;
      display:none; align-items:center; gap:.35rem;
      padding:.25rem .5rem; font-size:.7rem; border-radius:.45rem;
      background:#dc2626; z-index:12;
    }
    .live-dot{ width:.45rem; height:.45rem; border-radius:999px; background:white; animation:pulse 1.2s infinite; }
    @keyframes pulse{ 0%{opacity:.4; transform:scale(.8)} 50%{opacity:1; transform:scale(1)} 100%{opacity:.4; transform:scale(.8)} }

    .q-wrap{ position:absolute; right:.5rem; bottom:.5rem; display:flex; align-items:center; gap:.4rem; z-index:20; }
    .q-btn{ display:flex; align-items:center; gap:.35rem; font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); cursor:pointer; }
    .q-btn:hover{ background:rgba(255,255,255,.08); }
    .q-menu{ position:absolute; right:0; bottom:2.2rem; background:#0b1220; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:.35rem; display:none; z-index:30; min-width:96px; }
    .q-item{ display:flex; align-items:center; gap:.45rem; padding:.35rem .5rem; border-radius:.45rem; font-size:12px; cursor:pointer; white-space:nowrap; }
    .q-item:hover{ background:rgba(255,255,255,.08); }
    .q-dot{ width:8px; height:8px; border-radius:999px; background:#60a5fa; opacity:.9; }

    .list-wrap{ background:#0f172a; border:1px solid #253046; border-radius:12px; overflow:hidden; }
    .list-item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-top:1px solid #253046; }
    .list-item:first-child{ border-top:0; }
    .list-item a{ color:#cbd5e1; text-decoration:none; }
    .list-item a:hover{ color:#fff; }
    .btn-ghost{ font-size:12px; padding:6px 10px; border:1px solid #334155; border-radius:8px; background:transparent; color:#cbd5e1; }
    .btn-ghost:hover{ background:#1f2937; color:#fff; }
  </style>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);
    const qsa=(s,e=document)=>Array.from(e.querySelectorAll(s));
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    const params=new URLSearchParams(location.search);
    const CPA_KEY = params.get('cpa');                         // ex.: CPA1
    const MODE=(params.get('mode')||'edit').toLowerCase();     // 'edit' | 'view'
    const isView = MODE==='view';

    /* ===== Login ===== */
    const AUTH_USER='OPERACAOCPM';
    const AUTH_PASS='CAVPMDRONES';
    const REMEMBER_MIN=240;

    function auth_ok_until(){ const v=localStorage.getItem('auth_ok_until'); return v?parseInt(v,10):0; }
    function set_auth_ok(){ localStorage.setItem('auth_ok_until', String(Date.now()+REMEMBER_MIN*60*1000)); }
    function ensureAuthOrAsk(cb){
      try{
        if(auth_ok_until()>Date.now()) return cb(true);
        const overlay=qs('#authOverlay'); overlay.style.display='flex';
        const form=qs('#authForm');
        const handler=(e)=>{ e.preventDefault();
          const u=qs('#authUser').value.trim(), p=qs('#authPass').value;
          if(u===AUTH_USER && p===AUTH_PASS){
            set_auth_ok(); overlay.style.display='none';
            form.removeEventListener('submit',handler); cb(true);
          }else{
            const err=qs('#authErr'); err.classList.remove('hidden');
            setTimeout(()=>err.classList.add('hidden'),1500); cb(false);
          }
        };
        form.addEventListener('submit', handler);
      }catch(err){ console.error('Auth error', err); cb(false); }
    }

    /* ===== Firebase ===== */
    const FIREBASE = {
      apiKey: "AIzaSyDadspZB30sQOgZr7PTcSbub1ZJB80Kui4",
      authDomain: "dashboarddronepmesp.firebaseapp.com",
      databaseURL: "https://dashboarddronepmesp-default-rtdb.firebaseio.com",
      projectId: "dashboarddronepmesp",
      storageBucket: "dashboarddronepmesp.firebasestorage.app",
      messagingSenderId: "769998411213",
      appId: "1:769998411213:web:f0ecce2126f0af9b4a2084",
      measurementId: "G-4TVLS703CF"
    };
    firebase.initializeApp(FIREBASE);
    const db=firebase.database();

    const DB_PATH = CPA_KEY ? `dashboards/${CPA_KEY}` : null;
    const dbRef = DB_PATH ? db.ref(DB_PATH) : null;
    const CPAS_META_PATH = 'cpas';
    const cpasRef = db.ref(CPAS_META_PATH);

    /* ===== Estado ===== */
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIEW_COLS_OVERRIDE=null;

    let VIDEO_IDS=[], LABELS=[], LOCS=[];
    let MAIN_ID=null;
    let YT_READY=false;

    const players = {};
    let mainPlayer = null;
    const activeGrid = new Set();
    const LRU = [];

    /* ===== Performance ===== */
    const DEFAULT_QUALITY='tiny'; // 144p
    const MAX_CONCURRENT_GRID = 4;
    const CREATE_STAGGER_MS = 250;
    let LOW_BW_MODE = false;

    const Q_KEY_PREFIX='liveQ_';
    const Q_ORDER=['tiny','small','medium','large','hd720','hd1080','highres'];
    const Q_LABEL={tiny:'144p',small:'240p',medium:'360p',large:'480p',hd720:'720p',hd1080:'1080p',highres:'Máx.'};

    const PLACEHOLDER_IMG = "ARTE.png";
    const thumbUrl=(_id)=> PLACEHOLDER_IMG;

    function getSavedQ(id){ return localStorage.getItem(Q_KEY_PREFIX+id); }
    function saveQ(id,q){ localStorage.setItem(Q_KEY_PREFIX+id,q); }

    const idFromUrl=u=>{
      try{
        const url=new URL(u);
        const list=url.searchParams.get('list'); if(list) return list;
        const v=url.searchParams.get('v'); if(v) return v;
        if(url.hostname.includes('youtu.be')) return url.pathname.slice(1);
      }catch(_){}
      if(typeof u==='string'){
        if(u.includes('list=')) return u.split('list=')[1].split('&')[0];
        if(u.includes('watch?v=')) return u.split('v=')[1].split('&')[0];
      }
      return (u||'').trim();
    };
    const isPlaylistId=(id)=> typeof id==='string' && (id.startsWith('PL')||id.startsWith('UU')||id.startsWith('LL')||id.length>12);

    function setLiveBadge(cardEl, flag){
      if(!cardEl) return;
      let badge = cardEl.querySelector('[data-live-badge]');
      if(!badge){
        badge = document.createElement('div');
        badge.className='live-badge';
        badge.setAttribute('data-live-badge','');
        badge.innerHTML = '<span class="live-dot"></span><span>AO VIVO</span>';
        cardEl.querySelector('.video-box').appendChild(badge);
      }
      badge.style.display = flag ? 'inline-flex' : 'none';
    }

    window.onYouTubeIframeAPIReady=function(){ YT_READY=true; if(CPA_KEY){ renderAll(); } };

    function qualityControlTemplate(currentLabel){
      return `
        <div class="q-wrap">
          <button type="button" class="q-btn" data-qbtn>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="opacity-90">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.89 3.31.877 2.42 2.42a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.89 1.543-.877 3.31-2.42 2.42a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.89-3.31-.877-2.42-2.42A1.724 1.724 0 004.317 13.65c-1.756-.426-1.756-2.924 0-3.35A1.724 1.724 0 005.383 7.73c-.89-1.543.877-3.31 2.42-2.42.99.57 2.232.04 2.522-.993z"/>
              <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
            </svg>
            <span data-qlabel>${currentLabel}</span>
          </button>
          <div class="q-menu" data-qmenu>
            ${Q_ORDER.map(q=>`<div class="q-item" data-q="${q}"><span class="q-dot"></span>${Q_LABEL[q]}</div>`).join('')}
          </div>
        </div>
      `;
    }

    document.addEventListener('click', (ev)=>{
      const rmBtn = ev.target.closest('[data-remove]');
      if(rmBtn){
        if(isView) return; // viewer nunca remove
        const card = ev.target.closest('.video-card');
        if(!card) return;
        const id = card.getAttribute('data-vid');
        const idx = VIDEO_IDS.indexOf(id);
        if(idx>-1){
          if(!confirm('Remover esta equipe?')) return;
          VIDEO_IDS.splice(idx,1); LABELS.splice(idx,1); LOCS.splice(idx,1);
          if(MAIN_ID===id) MAIN_ID = VIDEO_IDS[0] || null;
          saveRealtime(); renderAll();
        }
        return;
      }

      const qBtn = ev.target.closest('[data-qbtn]');
      if(qBtn){
        const menu = qBtn.parentElement.querySelector('[data-qmenu]');
        const open = menu.style.display==='block';
        qsa('.q-menu').forEach(m=> m.style.display='none');
        menu.style.display = open ? 'none' : 'block';
        ev.stopPropagation();
        return;
      }

      const qItem = ev.target.closest('.q-item');
      if(qItem){
        const card = ev.target.closest('.video-card');
        const id = card.getAttribute('data-vid');
        const idxAttr = card.getAttribute('data-idx'); // "main" ou número
        const q  = qItem.getAttribute('data-q');
        saveQ(id,q);

        if(idxAttr==='main' && mainPlayer){
          try{ mainPlayer.setPlaybackQuality(q); enforceQuality(mainPlayer,q); }catch(_){}
        }else{
          const idx = parseInt(idxAttr,10);
          const player = players[idx];
          try{ player && player.setPlaybackQuality && player.setPlaybackQuality(q); enforceQuality(player,q); }catch(_) {}
        }

        const lbl = card.querySelector('[data-qlabel]'); if(lbl) lbl.textContent = Q_LABEL[q]||q;
        const menu = card.querySelector('[data-qmenu]'); if(menu) menu.style.display='none';
        return;
      }

      if(!ev.target.closest('.q-wrap')){ qsa('.q-menu').forEach(m=> m.style.display='none'); }
    });

    function touchLRU(idx){ const pos = LRU.indexOf(idx); if(pos>=0) LRU.splice(pos,1); LRU.push(idx); }
    function evictIfNeeded(){
      while(activeGrid.size > MAX_CONCURRENT_GRID){
        const victim = LRU.shift();
        if(victim==null) break;
        if(!activeGrid.has(victim)) continue;
        destroyGridPlayer(victim);
      }
    }

    function pickAvailableQuality(requested, available){
      const avail=new Set(available||[]);
      if (avail.has(requested)) return requested;
      const Q_ORDER=['highres','hd1080','hd720','large','medium','small','tiny'];
      for(const q of Q_ORDER) if (avail.has(q)) return q;
      return requested;
    }
    function enforceQuality(player, desired, cycles=10, interval=500){
      let n=0; const iv=setInterval(()=>{
        try{
          const avail=player.getAvailableQualityLevels?player.getAvailableQualityLevels():[];
          const best=pickAvailableQuality(desired, avail);
          player.setPlaybackQuality?.(best);
        }catch(_){}
        if(++n>=cycles) clearInterval(iv);
      }, interval);
    }

    function createGridPlayer(i, id, isPl){
      if(LOW_BW_MODE) return;
      if(activeGrid.size >= MAX_CONCURRENT_GRID){ evictIfNeeded(); if(activeGrid.size >= MAX_CONCURRENT_GRID) return; }
      const mountId = `yt_${i}`;
      const savedQ = getSavedQ(id) || 'tiny';
      const cfg = {
        width:'100%', height:'100%',
        playerVars:{ autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
        events:{
          onReady:e=>{
            try{
              const info = e.target.getVideoData ? e.target.getVideoData() : {};
              const dur  = typeof e.target.getDuration === 'function' ? e.target.getDuration() : null;
              const isLive = (info && info.isLiveContent) || dur === 0;

              const card=qs(`#card_${i}`);
              setLiveBadge(card, !!isLive);

              if(!isLive){
                setOfflineEl(`off_${i}`, true);
                destroyGridPlayer(i);
                return;
              }

              e.target.mute(); e.target.playVideo();
              const avail=e.target.getAvailableQualityLevels?e.target.getAvailableQualityLevels():[];
              const best=pickAvailableQuality(savedQ, avail);
              e.target.setPlaybackQuality?.(best);
              enforceQuality(e.target, best);

              const lbl=card?.querySelector('[data-qlabel]'); if(lbl) lbl.textContent=Q_LABEL[best]||best;
              if(!getSavedQ(id)) saveQ(id, best);
              setOfflineEl(`off_${i}`, false);

              activeGrid.add(i); touchLRU(i);
              const iframe = qs(`#${mountId} iframe`); if(iframe){ iframe.setAttribute('loading','lazy'); }
            }catch(_){}
          },
          onStateChange:e=>{
            if (typeof YT!=='undefined' && YT.PlayerState){
              const online = (e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.BUFFERING);
              setOfflineEl(`off_${i}`, !online);
              if(e.data===YT.PlayerState.ENDED) setLiveBadge(qs(`#card_${i}`), false);
            }
            touchLRU(i);
          }
        }
      };
      if(isPl){ cfg.playerVars.listType='playlist'; cfg.playerVars.list=id; } else { cfg.videoId=id; }
      players[i] = new YT.Player(mountId, cfg);
    }

    function destroyGridPlayer(i){
      const p = players[i];
      if(p && p.destroy){ try{ p.destroy(); }catch(_){ } }
      players[i] = null;
      activeGrid.delete(i);
      const card = qs(`#card_${i}`);
      if(card){
        const fill  = card.querySelector('.player-fill');
        if(fill)  fill.innerHTML = '';
        setLiveBadge(card, false);
      }
    }
    function setOfflineEl(elId, flag){ const ov = document.getElementById(elId); if(ov) ov.style.display = flag ? 'flex' : 'none'; }

    function createMain(id){
      const isPl = isPlaylistId(id);
      const savedQ = getSavedQ(id) || 'tiny';
      const cfg = {
        width:'100%', height:'100%',
        playerVars:{ autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1 },
        events:{
          onReady:e=>{
            try{
              const info = e.target.getVideoData ? e.target.getVideoData() : {};
              const dur  = typeof e.target.getDuration === 'function' ? e.target.getDuration() : null;
              const isLive = (info && info.isLiveContent) || dur === 0;

              const cont=qs('#mainContainer');
              setLiveBadge(cont, !!isLive);

              if(!isLive){
                setOfflineEl('off_main', true);
                try{ mainPlayer && mainPlayer.destroy && mainPlayer.destroy(); }catch(_){}
                mainPlayer = null;
                return;
              }

              e.target.mute(); e.target.playVideo();

              const avail=e.target.getAvailableQualityLevels?e.target.getAvailableQualityLevels():[];
              const best=pickAvailableQuality(savedQ, avail);
              e.target.setPlaybackQuality?.(best);
              enforceQuality(e.target, best);
              const lbl=qs('#mainContainer [data-qlabel]'); if(lbl) lbl.textContent=Q_LABEL[best]||best;
              if(!getSavedQ(id)) saveQ(id, best);
              setOfflineEl('off_main', false);
              const iframe = qs('#yt_main iframe'); if(iframe){ iframe.setAttribute('loading','lazy'); }
            }catch(_){}
          },
          onStateChange:e=>{
            if (typeof YT!=='undefined' && YT.PlayerState){
              const online = (e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.BUFFERING);
              setOfflineEl('off_main', !online);
              if(e.data===YT.PlayerState.ENDED) setLiveBadge(qs('#mainContainer'), false);
            }
          }
        }
      };
      if(isPl){ cfg.playerVars.listType='playlist'; cfg.playerVars.list=id; } else { cfg.videoId=id; }
      mainPlayer = new YT.Player('yt_main', cfg);
    }

    function renderAll(){ renderMain(); renderGrid(); }

    function renderMain(){
      const cont = qs('#mainContainer'); cont.innerHTML='';
      if(!VIDEO_IDS.length){ cont.classList.add('hidden'); return; }
      cont.classList.remove('hidden');

      const id = ( (MAIN_ID && VIDEO_IDS.includes(MAIN_ID)) ? MAIN_ID : (VIDEO_IDS[0]||null) );
      if(!id){ cont.classList.add('hidden'); return; }

      const idx = VIDEO_IDS.indexOf(id);
      const label = LABELS[idx] || `Equipe ${idx+1}`;
      const loc   = LOCS[idx]   || '';
      const isPl  = isPlaylistId(id);
      const fullUrl = isPl ? `https://www.youtube.com/playlist?list=${encodeURIComponent(id)}` : `https://www.youtube.com/watch?v=${encodeURIComponent(id)}`;
      const savedQ = getSavedQ(id) || 'tiny';

      const card = document.createElement('div');
      card.className='video-card';
      card.dataset.vid=id;
      card.dataset.idx='main';
      const tUrl = thumbUrl(id);

      card.innerHTML = `
        <div class="video-box">
          <div class="thumb" data-thumb><img src="${tUrl}" alt="thumbnail institucional" loading="lazy"></div>
          <div class="live-badge" data-live-badge style="display:none;"><span class="live-dot"></span><span>AO VIVO</span></div>
          <div id="yt_main" class="player-fill"></div>
          <div class="absolute top-2 right-2 flex gap-2 controls">
            <button class="tile-btn" onclick="window.open('${fullUrl}','_blank')">Tela cheia</button>
            ${isView ? '' : `<button class="tile-btn" data-remove>Remover</button>`}
          </div>
          <div class="offline-overlay" id="off_main"><div class="offline-badge"><span>aguardando sinal</span></div></div>
          ${qualityControlTemplate('144p')}
        </div>
        <div class="px-3 pt-2 pb-3 bg-gray-800/70">
          <h3 class="font-semibold text-base">${esc(label)}</h3>
          <p class="text-gray-400 text-sm">${esc(loc)}</p>
        </div>
      `;
      cont.appendChild(card);
      if(YT_READY) createMain(id);
    }

    function renderGrid(){
      const grid=qs('#gridContainer'); grid.innerHTML=''; applyGridCols();
      Object.keys(players).forEach(k=> destroyGridPlayer(Number(k)));
      activeGrid.clear(); LRU.length=0;

      if(!VIDEO_IDS.length){
        grid.innerHTML=isView?'Aguardando configuração do operador.':'Clique em <b>Inserir Equipe</b> no topo.';
        return;
      }
      const anchorId = ( (MAIN_ID&&VIDEO_IDS.includes(MAIN_ID))?MAIN_ID:(VIDEO_IDS[0]||null) );
      const idsForGrid = VIDEO_IDS.filter(id => id !== anchorId);
      if(LABELS.length<VIDEO_IDS.length){ for(let i=LABELS.length;i<VIDEO_IDS.length;i++) LABELS[i]=`Equipe ${String(i+1).padStart(2,'0')}`; }
      if(LOCS.length<VIDEO_IDS.length){   for(let i=LOCS.length;i<VIDEO_IDS.length;i++)   LOCS[i]=''; }

      idsForGrid.forEach((id,i)=>{
        const idxOriginal = VIDEO_IDS.indexOf(id);
        const isPl=isPlaylistId(id);
        const fullUrl = isPl ? `https://www.youtube.com/playlist?list=${encodeURIComponent(id)}` : `https://www.youtube.com/watch?v=${encodeURIComponent(id)}`;
        const card=document.createElement('div');
        card.className='video-card'; card.dataset.idx=String(i); card.dataset.vid=id; card.id=`card_${i}`;
        const tUrl = thumbUrl(id);
        card.innerHTML=
          `<div class="video-box">
             <div class="thumb" data-thumb><img src="${tUrl}" alt="thumbnail institucional" loading="lazy"></div>
             <div class="live-badge" data-live-badge style="display:none;"><span class="live-dot"></span><span>AO VIVO</span></div>
             <div id="yt_${i}" class="player-fill"></div>
             <div class="absolute top-2 right-2 flex gap-2 controls">
               <button class="tile-btn" onclick="window.open('${fullUrl}','_blank')">Tela cheia</button>
               ${isView ? '' : `<button class="tile-btn" data-remove>Remover</button>`}
             </div>
             <div class="offline-overlay" id="off_${i}"><div class="offline-badge"><span>aguardando sinal</span></div></div>
             ${qualityControlTemplate('144p')}
           </div>
           <div class="px-2 pt-1 pb-2 bg-gray-800/70">
             <h3 class="font-medium text-sm">${esc(LABELS[idxOriginal]||'Equipe '+(idxOriginal+1))}</h3>
             <p class="text-gray-400 text-[11px]">${esc(LOCS[idxOriginal]||'')}</p>
           </div>`;
        grid.appendChild(card);
      });

      const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          const card = entry.target; const idx = Number(card.dataset.idx); const id  = card.dataset.vid; const isPl= isPlaylistId(id);
          if(entry.isIntersecting){
            setTimeout(()=>{
              if(LOW_BW_MODE) return;
              if(players[idx]){ activeGrid.add(idx); touchLRU(idx); return; }
              createGridPlayer(idx, id, isPl);
              setTimeout(()=>evictIfNeeded(), CREATE_STAGGER_MS);
            }, CREATE_STAGGER_MS * (idx%4));
          }else{ if(players[idx]) destroyGridPlayer(idx); }
        });
      }, { rootMargin:'100px 0px', threshold:0.1 });
      document.querySelectorAll('.video-card[data-idx]').forEach(card=> io.observe(card));
    }

    const OFFLINE_POLL_MS = 10000;
    setInterval(()=>{
      if(mainPlayer && typeof YT!=='undefined' && YT.PlayerState){
        try{
          const st = mainPlayer.getPlayerState ? mainPlayer.getPlayerState() : null;
          if(st!=null){
            const on = (st===YT.PlayerState.PLAYING || st===YT.PlayerState.BUFFERING);
            setOfflineEl('off_main', !on);
            if(!on) setLiveBadge(qs('#mainContainer'), false);
          }
        }catch(_){}
      }
      Object.keys(players).forEach(k=>{
        const i = Number(k);
        const p = players[i];
        if(!p || typeof YT==='undefined' || !YT.PlayerState) return;
        try{
          const st = p.getPlayerState ? p.getPlayerState() : null;
          const on = (st===YT.PlayerState.PLAYING || st===YT.PlayerState.BUFFERING);
          setOfflineEl(`off_${i}`, !on);
          if(!on) setLiveBadge(qs(`#card_${i}`), false);
        }catch(_){}
      });
    }, OFFLINE_POLL_MS);

    function saveRealtime(){
      if(!dbRef) return;
      dbRef.set({ ids:VIDEO_IDS, labels:LABELS, locs:LOCS, cols:COLS, main: MAIN_ID || null, ts:Date.now() })
        .catch(err=>{ console.error('Erro ao salvar RTDB:', err); alert('Falha ao salvar no Firebase. Verifique conexão/permissões.'); });
    }
    function subscribeRealtime(){
      if(!dbRef) return;
      dbRef.on('value', snap=>{
        const j=snap.val(); if(!j) { renderAll(); return; }
        const newIds=j.ids||[], newLabels=j.labels||[], newLocs=j.locs||[];
        COLS = parseInt(j.cols||COLS||2,10);
        MAIN_ID = j.main || MAIN_ID || newIds[0] || null;
        VIDEO_IDS=newIds.slice(); LABELS=newLabels.slice(); LOCS=newLocs.slice();
        renderAll();
      });
    }

    function subscribeCpaTitle(){
      if(!CPA_KEY) return;
      const node = cpasRef.child(CPA_KEY);
      node.on('value', snap=>{
        const t = (snap.val() && snap.val().title) ? snap.val().title : CPA_KEY;
        qs('#hdrSubtitle').textContent = `Painel — ${t}`;
        document.title = `Dashboard Drones — ${t}`;
      });
    }

    /* Landing + renomear CPA (com auth) */
    function renderLanding(){
      qs('#panelCPA')?.classList.add('hidden');
      qs('#editorControls')?.classList.add('hidden');
      const land = qs('#landing'); land.classList.remove('hidden');
      qs('#hdrSubtitle').textContent = 'Selecione um CPA';

      const wrap = qs('#landingList'); wrap.innerHTML = '';
      const defaults = { CPA1:'CPA 1', CPA2:'CPA 2', CPA3:'CPA 3', CPA4:'CPA 4' };

      function renameCPA(key, currentTitle){
        ensureAuthOrAsk(async ok=>{
          if(!ok) return;
          const nv = prompt(`Novo nome para ${key}:`, currentTitle);
          if(nv===null) return;
          const title = nv.trim();
          if(!title) return;
          try{
            await db.ref(`${CPAS_META_PATH}/${key}`).set({ title });
            alert('Nome atualizado.');
          }catch(err){
            console.error('Erro ao renomear CPA:', err);
            alert('Erro ao salvar o nome: ' + (err?.message || err));
          }
        });
      }

      cpasRef.on('value', snap=>{
        const data = snap.val() || {};
        wrap.innerHTML = '';
        ['CPA1','CPA2','CPA3','CPA4'].forEach(key=>{
          const title = (data[key] && data[key].title) ? data[key].title : defaults[key];
          const li = document.createElement('div');
          li.className='list-item';

          const left = document.createElement('div');
          left.innerHTML = `<a href="${location.pathname}?cpa=${encodeURIComponent(key)}&mode=edit&cols=2" class="text-base">${esc(title)}</a>
                            <div class="text-xs text-slate-400 mt-0.5">${esc(key)}</div>`;

          const right = document.createElement('div');
          const editBtn = document.createElement('button');
          editBtn.className='btn-ghost';
          editBtn.textContent='✎ Renomear';
          editBtn.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            renameCPA(key, title);
          });
          right.appendChild(editBtn);

          li.appendChild(left);
          li.appendChild(right);
          wrap.appendChild(li);
        });
      });
    }

    function applyGridCols(){
      const cols = (isView && VIEW_COLS_OVERRIDE!=null) ? VIEW_COLS_OVERRIDE : COLS;
      const grid=qs('#gridContainer');
      if(grid) grid.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
      const layout=qs('#layout'); if(layout) layout.value=String(cols);
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Sem CPA -> Landing
      if(!CPA_KEY){ renderLanding(); return; }

      // Com CPA
      qs('#panelCPA')?.classList.remove('hidden');

      // Controles do topo: em VIEW só mostram layout/fullscreen/compartilhar
      const ctrl = qs('#editorControls');
      ctrl?.classList.remove('hidden');
      qs('#btnConfig')?.classList.toggle('hidden', isView);
      qs('#btnClearAll')?.classList.toggle('hidden', isView);
      // LOW BW pode ser útil no viewer também, então mantive visível

      // Layout: viewer muda local (sem salvar); editor salva em RTDB
      qs('#layout')?.addEventListener('change', ()=>{
        const val = parseInt(qs('#layout').value,10)||2;
        VIEW_COLS_OVERRIDE = val;
        applyGridCols();
        if(!isView){ COLS = val; saveRealtime(); }
      });

      qs('#btnFullscreen')?.addEventListener('click',()=>{
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
      });

      // Inserir Equipe: exige auth e só no modo edit
      qs('#btnConfig')?.addEventListener('click', ()=>{
        if(isView) return; // nunca abre no viewer
        ensureAuthOrAsk(ok=>{ if(ok) qs('#configModal').classList.remove('hidden'); });
      });

      // Botão Adicionar dentro do modal
      qs('#btnAddTeam')?.addEventListener('click', (e)=>{
        e.preventDefault();
        if(isView) return; // segurança extra
        ensureAuthOrAsk(ok=>{
          if(!ok) return;
          const name=qs('#teamName').value.trim();
          const loc=qs('#teamLocation').value.trim();
          const url=qs('#youtubeUrl').value.trim();
          if(!name||!url){ alert('Preencha Nome e URL'); return; }
          const id=idFromUrl(url);
          if(!id){ alert('URL inválida do YouTube/Playlist.'); return; }
          if(!dbRef){ alert('CPA inválido na URL. Abra via landing.'); return; }
          VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);
          if(!getSavedQ(id)) saveQ(id, 'tiny');
          if(!MAIN_ID) MAIN_ID = id;
          saveRealtime(); renderAll();
          qs('#configModal').classList.add('hidden'); qs('#teamForm').reset();
        });
      });

      qs('#btnShare')?.addEventListener('click', ()=>{
        const base=location.origin+location.pathname;
        const url=new URL(base);
        url.searchParams.set('mode','view');
        url.searchParams.set('cols', String(COLS));
        url.searchParams.set('cpa', CPA_KEY);
        navigator.clipboard.writeText(url.toString()).then(()=>alert('Link do VISUALIZADOR copiado:\n\n'+url.toString()));
      });

      qs('#btnLowBW')?.addEventListener('click', ()=>{
        LOW_BW_MODE = !LOW_BW_MODE;
        const b=qs('#btnLowBW');
        b.classList.toggle('bg-green-600', LOW_BW_MODE);
        b.classList.toggle('bg-gray-700', !LOW_BW_MODE);
        b.textContent = LOW_BW_MODE ? 'Modo Baixa Largura: ON' : 'Modo Baixa Largura: OFF';
        if(LOW_BW_MODE){ Object.keys(players).forEach(k=> destroyGridPlayer(Number(k))); } else { renderGrid(); }
      });

      qs('#btnClearAll')?.addEventListener('click', ()=>{
        if(isView) return; // viewer não limpa
        ensureAuthOrAsk(ok=>{
          if(!ok) return;
          if(!confirm('Apagar TODAS as equipes do dashboard deste CPA?')) return;
          VIDEO_IDS=[]; LABELS=[]; LOCS=[]; MAIN_ID=null;
          saveRealtime(); renderAll();
        });
      });

      // Fechar modal clicando fora
      document.addEventListener('click', (ev)=>{
        if(ev.target.id==='configModal') { qs('#configModal').classList.add('hidden'); }
      });

      subscribeRealtime();
      subscribeCpaTitle();
    });
  })();
  </script>
</head>
<body class="min-h-screen">

  <!-- Overlay de Login -->
  <div id="authOverlay" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/70">
    <div class="bg-gray-800 text-white w-full max-w-sm rounded-xl shadow-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Acesso restrito</h2>
      <form id="authForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Usuário</label>
          <input id="authUser" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="usuário" autocomplete="username">
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="authPass" type="password" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="senha" autocomplete="current-password">
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Entrar</button>
        <p id="authErr" class="text-red-400 text-sm hidden">Usuário ou senha incorretos.</p>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="p-4 bg-gray-900 border-b border-gray-700 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Logo_PMESP.png"
             alt="PMESP"
             class="w-10 h-10 object-contain rounded bg-white/5 p-1">
        <div class="flex items-center gap-3">
          <div>
            <h1 class="text-lg font-bold">Dashboard Programa de Policiamento com Drones</h1>
            <p id="hdrSubtitle" class="text-gray-400 text-xs">Monitoramento em Tempo Real • Firebase RT • v15.5</p>
          </div>
          <img src="qualidade%20melhor%20-Photoroom.png" alt="Comando de Aviação da PMESP"
               class="w-10 h-10 object-contain rounded bg-white/5 p-1 ml-1">
        </div>
      </div>

      <div id="editorControls" class="flex items-center gap-2 hidden">
        <label class="text-xs text-gray-400">Layout</label>
        <select id="layout" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
          <option value="2">2 colunas</option>
          <option value="3">3 colunas</option>
          <option value="4">4 colunas</option>
        </select>
        <button id="btnFullscreen" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Tela Cheia</button>
        <button id="btnShare" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Gerar Link</button>
        <button id="btnConfig" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Inserir Equipe</button>
        <button id="btnLowBW" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm" title="Pausa/destrói players do GRID para economizar banda/CPU.">Modo Baixa Largura: OFF</button>
        <button id="btnClearAll" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Limpar</button>
      </div>
    </div>
  </header>

  <!-- LANDING -->
  <section id="landing" class="max-w-7xl mx-auto p-4 hidden">
    <div class="mb-3">
      <h2 class="text-xl font-semibold">Comandos de Policiamento (CPA)</h2>
      <p class="text-slate-300 text-sm">Clique para abrir o painel. Use ✎ para renomear.</p>
    </div>
    <div class="list-wrap" id="landingList"></div>
  </section>

  <!-- PAINEL DO CPA -->
  <div id="panelCPA" class="hidden">
    <section class="max-w-7xl mx-auto p-4">
      <div id="mainContainer" class="video-card hidden"></div>
    </section>
    <main class="p-4 max-w-7xl mx-auto">
      <div id="gridContainer" class="grid-container"></div>
    </main>
  </div>

  <!-- Modal Inserir -->
  <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4 text-center">Inserir Equipe</h3>
        <form id="teamForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Nome da Equipe</label>
            <input id="teamName" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Ex.: Equipe Alfa">
          </div>
          <div>
            <label class="block text-sm mb-1">Endereço da Operação</label>
            <input id="teamLocation" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Av. Olavo Fontoura, 1078">
          </div>
          <div>
            <label class="block text-sm mb-1">URL da Playlist/Vídeo</label>
            <input id="youtubeUrl" type="url" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="https://www.youtube.com/playlist?list=PLxxx ou https://www.youtube.com/watch?v=abc123">
          </div>
          <div class="flex gap-3 pt-2">
            <button id="btnAddTeam" type="button" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded">Adicionar</button>
            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded"
              onclick="document.getElementById('configModal').classList.add('hidden'); document.getElementById('teamForm').reset();">
              Cancelar
            </button>
          </div>
        </form>
        <p class="mt-3 text-xs text-slate-400 text-center">Salva em <code>dashboards/CPA*</code> no Firebase Realtime Database.</p>
      </div>
    </div>
  </div>

</body>
</html>
